

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Mountain Lab</title>
    <meta name="description" content="Details about he Mountain Lab framework">
    <meta name="author" content="Jeremy Magland & Alex Morley">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/kbroman.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->

    <!-- atom & rss feed -->
    <link href="nil" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="nil" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">MountainLab</a>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

<div class="page-header">
  <h2>Mountain Lab  <small>End-to-End Data Processing Pipelines</small></h2>
</div>

<div class="row-fluid">
  <div class="span12">
    <p><a href="https://travis-ci.org/flatironinstitute/mountainlab-js"><img src="https://travis-ci.org/flatironinstitute/mountainlab-js.svg?branch=master" alt="Build Status" /></a></p>

<h1 id="mountainlab-javascript-implementation">MountainLab (JavaScript implementation)</h1>

<p>MountainLab is data processing, sharing and visualization software for scientists. It is built around MountainSort, spike sorting software, but is designed to be much more generally applicable.</p>

<h1 id="credits-and-acknowledgements">Credits and acknowledgements</h1>

<p>The framework was conceived by and primarily implemented by Jeremy Magland at the Flatiron Institute and is released under the Apache license v2.</p>

<p>The web infrastructure is currently under development by Jeremy Magland and Alex Morley.</p>

<p>Other key collaborators include members of the numerical algorithms group at Flatiron Institute, including Alex Barnett (group leader), Leslie Greengard, Joakim Anden, Witold Wysota, and James Jun. Dylan Simon has contributed to the web infrastructure.</p>

<p>Jason Chung, Loren Frank, Leslie Greengard and Alex Barnett are direct collaborators in our spike sorting efforts and have therefore contributed to MountainLab, which has a broader scope. Other MountainSort users have contributed invaluable feedback, particularly investigators at UCSF (Mari Sosa has contributed code to the project).</p>

<p>MountainLab will also play a central role in the implementation of a website for comparing spike sorting algorithms on a standard set of ground-truth datasets. Alex Barnett, Jeremy Magland, and James Jun are leading this effort, but it is a community project, and we hope to have a lot of involvement from other players in the field of electrophysiology and spike sorting.</p>

<p>Alex Morley has a project and vision for applying continuous integration principles to research which will most likely use MountainLab as a core part of its implementation.</p>

<p>(If I have neglected to acknowledge your contribution, please remind me.)</p>

<h2 id="installation">Installation</h2>

<p>Using Linux is recommended.</p>

<p>This should also work on Mac OS X, but has not been very well tested. See <a href="./docs/notes_on_osx.md">notes on OS X</a>.</p>

<p>At some point, this may run on windows.</p>

<p>Note: If you have a prior version of MountainLab installed, then you may want to uninstall it for sanity’s sake (either via apt-get remove or by removing mountainlab/bin from your path), although it is possible for them to co-exist since the command-line utilities have different names. Note that the processor plugin libraries work equally well and simultaneously with both (we have <em>not</em> changed the .mp spec system, see below).</p>

<h3 id="step-1-install-the-prerequisites">Step 1: Install the prerequisites</h3>

<ul>
  <li>NodeJS – you must use a recent version. <a href="./docs/prerequisites.md">Details.</a></li>
  <li>MongoDB – <a href="./docs/prerequisites.md">Details.</a></li>
  <li>Python 3 with pip – optional but required for most plugin packages. <a href="./docs/prerequisites.md">Details.</a></li>
</ul>

<h3 id="step-2-clone-this-repository-and-install-using-npm-node-package-manager">Step 2: Clone this repository and install using npm (node package manager)</h3>

<p>Open a terminal, <code class="highlighter-rouge">cd</code> to an installation folder, and then run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/flatironinstitute/mountainlab-js
cd mountainlab-js
npm install
</code></pre></div></div>
<p>Then, add “mountainlab-js/bin” to your PATH variable. This can be done by adding the following line to your ~/.bashrc file and then opening a new terminal:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=[your/path/to]/mountainlab-js/bin:$PATH
</code></pre></div></div>

<p>Test the installation by running</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-config
</code></pre></div></div>

<p>The output of this command will explain how to configure MountainLab on your system (it simply involves setting environment variables by editing a .env file). Further information is provided below.</p>

<p>Further test the installation by running</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-list-processors
</code></pre></div></div>

<p>This should list the names of the system processors that are distributed with MountainLab-js</p>

<h3 id="step-3-install-plugin-processor-libraries">Step 3: Install plugin processor libraries</h3>

<p>Note: the following plugin processor libraries require python 3 and pip to be installed (see above).</p>

<p>Create the following folder:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p ~/.mountainlab/packages
</code></pre></div></div>

<p>This is the default location for plugin processor libraries (see the output of the ml-config command).</p>

<p>It is recommend that you use a python virtualenv for what follows. <a href="./docs/prerequisites.md">Details.</a>.</p>

<p>To get started with the examples, clone and install the following two packages. The first is for generic utilities for working with electrophysiology datasets. The second is our spike sorting algorithm, MountainSort v4.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/.mountainlab/packages
git clone https://github.com/magland/ml_ephys
cd ml_ephys
pip3 install --upgrade -r requirements.txt
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/.mountainlab/packages
git clone https://github.com/magland/ml_ms4alg
cd ml_ms4alg
pip3 install --upgrade -r requirements.txt
</code></pre></div></div>

<p>Now test that the new processors have been installed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-list-processors
</code></pre></div></div>

<h3 id="step-4-configuration">Step 4: Configuration</h3>

<p>As you will learn from running the <code class="highlighter-rouge">ml-config</code> command, MountainLab can be configured by setting environment variables. Ideally these should should be specified in the ~/.mountainlab/mountainlab.env file, but those values can also be overridden by setting the variables by command-line in the terminal.</p>

<p>The following are some of the configuration variables (they each have a default value if left empty):</p>
<ul>
  <li><code class="highlighter-rouge">ML_TEMPORARY_DIRECTORY</code> – the location where temporary data files are stored (default: /tmp/mountainlab-tmp)</li>
  <li><code class="highlighter-rouge">ML_PACKAGE_SEARCH_DIRECTORY</code> – the primary location for ML processing packages (default: ~/.mountainlab/packages)</li>
  <li><code class="highlighter-rouge">ML_ADDITIONAL_PACKAGE_SEARCH_DIRECTORIES</code> – optional additional directories to search for packages (colon separated list)</li>
  <li><code class="highlighter-rouge">ML_ADDITIONAL_PRV_SEARCH_DIRECTORIES</code> – optional additional directories to search for files pointed to by .prv objects</li>
</ul>

<h3 id="step-5-install-additional-programs">Step 5: Install additional programs</h3>

<p>If you are doing spike sorting, then you will also want to install the following for visualization:</p>

<p><a href="https://github.com/flatironinstitute/ephys-viz">ephys-viz</a> - Widgets for visualization of electrophysiology experiments and the results of spike sorting.</p>

<h2 id="command-reference">Command reference</h2>

<p>The following commands are available from any terminal. Use the <code class="highlighter-rouge">--help</code> flag on any of these to get more detailed information.</p>
<ul>
  <li><code class="highlighter-rouge">ml-config</code>  Show the current configuration (i.e., environment variables)</li>
  <li><code class="highlighter-rouge">ml-exec-process</code>  Run a processor job without involving the process cache for completed processes</li>
  <li><code class="highlighter-rouge">ml-lari-start</code>  Start a lari server, making your local machine a processing server</li>
  <li><code class="highlighter-rouge">ml-list-processors</code>  List all registered processors on the local machine</li>
  <li><code class="highlighter-rouge">ml-prv-create</code>  Create a new .prv file based on an existing data file (computes the sha1sum, etc)</li>
  <li><code class="highlighter-rouge">ml-prv-locate</code>  Locate a file on the local machine (or remotely) based on a .prv file</li>
  <li><code class="highlighter-rouge">ml-prv-sha1sum</code>  Compute the sha1sum of a data file (uses a cache for efficiency)</li>
  <li><code class="highlighter-rouge">ml-prv-stat</code>  Compute the prv object for a data file (uses a cache for efficiency)</li>
  <li><code class="highlighter-rouge">ml-queue-process</code>  Queue a processor job for running when resources become available</li>
  <li><code class="highlighter-rouge">ml-run-process</code>  Run a processor job</li>
  <li><code class="highlighter-rouge">ml-spec</code>  Retrieve the spec object for a particular registered processor</li>
  <li><code class="highlighter-rouge">mls-run</code> Run a processing script (.ml file)</li>
  <li><code class="highlighter-rouge">mls-spec</code> Show the spec for a processing script (.ml file)</li>
</ul>

<h2 id="installing-processor-packages">Installing processor packages</h2>

<p>MountainLab only ships with a few system processors, found in mountainlab-js/system-packages. To install additional processor packages, clone package repositories into the ~/.mountainlab/packages directory (or other configured directories). For example, see above for instructions on installing some packages recommended to get started.</p>

<p>MountainLab will recursively search in these locations to find <code class="highlighter-rouge">.mp</code> files with executable permissions. Each such file provides the spec information for a list of registered processors (see section on creating custom processor packages).</p>

<h2 id="a-note-about-using-previous-versions-of-mountainsort-with-mountainlab-js">A note about using previous versions of MountainSort with MountainLab-js</h2>

<p>The previous version of MountainSort is compatible with this new implementation of MountainLab. That’s because it has .mp files that conform to the same specification.</p>

<p>To use the MountainSort processor package, either install it from source within the <code class="highlighter-rouge">~/.mountainlab/packages</code> directory, or install it using the Ubuntu package. In the latter case you must add the following line to <code class="highlighter-rouge">~/.mountainlab/mountainlab.env</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ML_ADDITIONAL_PACKAGE_SEARCH_DIRECTORIES=/opt/mountainlab/packages
</code></pre></div></div>
<p>As suggested by the name, this tells MountainLab to also search in the <code class="highlighter-rouge">/opt/mountainlab/packages</code> for installed processing packages. This is the system location used in the Ubuntu package of MountainSort.</p>

<p>To create your own processor packages, see the section on that topic below.</p>

<h2 id="running-processor-jobs-from-the-command-line">Running processor jobs from the command-line</h2>

<p>Processors can either be run directly on the command-line, or indirectly through a processing script on MLStudy.
The command-line syntax (slightly different from the previous version of MountainLab) is:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-run-process &lt;processors-name&gt; --inputs [key:value input files] --outputs [key:value output files] --parameters [key:value parameters]
</code></pre></div></div>
<p>The options –inputs, –outputs, and –parameters may be abbreviates -i, -o, and -p, respectively. For example, to run a bandpass filter:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-run-process ephys.bandpass_filter --inputs timeseries:raw.mda --outputs timeseries_out:filt.mda --parameters samplerate:30000 --freq_min:300 --freq_max:6000
</code></pre></div></div>
<p>Note that .prv files can be substituted for both inputs or outputs. In such a case, where an input file has a .prv extension, MountainLab will search the local machine for the corresponding data file and substitute that in before running the processor (see the <code class="highlighter-rouge">ml-prv-locate</code> command). In the case that one of the <em>output</em> files has a .prv extension, MountainLab will store the output in a temporary file (in <code class="highlighter-rouge">ML_TEMPORARY_DIRECTORY</code>) and then create a corresponding .prv file in the output location specified in the command (see the <code class="highlighter-rouge">ml-prv-create</code> command).</p>

<p>Thus one can do command-line processing purely using .prv files, as in the following example of creating a synthetic electrophysiology dataset (which requires the ml_ephys processor library to be installed):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-run-process ephys.synthesize_random_waveforms --outputs waveforms_out:data/waveforms_true.mda.prv geometry_out:data/geom.csv --parameters upsamplefac:13 M:4
ml-run-process ephys.synthesize_random_firings --outputs firings_out:data/firings_true.mda.prv --parameters duration:600
ml-run-process ephys.synthesize_timeseries --inputs firings:data/firings_true.mda.prv waveforms:data/waveforms_true.mda.prv --outputs timeseries_out:data/raw.mda.prv --parameters duration:600 waveform_upsamplefac:13
</code></pre></div></div>

<p>All files will be stored in temporary locations, which can be retrieved using the <code class="highlighter-rouge">ml-prv-locate</code> command as follows:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml-prv-locate raw_synth.mda.prv 
/tmp/mountainlab-tmp/output_184a04c2877517f8996fd992b6f923bee8c6bbd2_timeseries_out
</code></pre></div></div>

<p>In place of <code class="highlighter-rouge">ml-run-process</code>, you may substitute <code class="highlighter-rouge">ml-exec-process</code> to bypass the process caching system, or <code class="highlighter-rouge">ml-queue-process</code> to have MountainLab wait for resources to be available before execution.</p>

<h2 id="examples">Examples</h2>

<p>Some spike sorting examples can be found in the examples/spike_sorting directory. There should be one subdirectory per example, with a readme.md file for each.</p>

<h2 id="custom-processor-libraries">Custom processor libraries</h2>

<p>Here is a list of user-contributed processor packages that we know of.
You may git clone each of these into your <code class="highlighter-rouge">~/.mountainlab/packages/</code> directory:</p>

<ul>
  <li>
    <p><a href="https://github.com/alexmorley/ddms"><code class="highlighter-rouge">ddms</code></a>:
tools by Alex Morley for converting to/from neurosuite format.</p>
  </li>
  <li>
    <p>Loren Frank’s lab processors (to come)</p>
  </li>
  <li>
    <p><a href="https://github.com/jamesjun/ironclust"><code class="highlighter-rouge">ironclust</code></a>: James Jun’s
CPU-only octave implementation of his <a href="https://github.com/JaneliaSciComp/JRCLUST/wiki">JRCLUST</a> algorithm, wrapped as a processor.</p>
  </li>
  <li>
    <p><a href="https://github.com/alexmorley/ml_identity"><code class="highlighter-rouge">ml_identity</code></a>:
A set of “hello world” processors in python, to show how to make a simple
processor and do file I/O.</p>
  </li>
</ul>

<p>You can also create your own MountainLab processor libraries using any language (python, C/C++, matlab, etc). Processor libraries are simply represented by executable .mp files that provide the specifications (spec) for a collection of processors together with command strings telling MountainLab how to execute those processors using system calls. For details, see <a href="docs/creating_custom_processor_libraries.md">creating custom processor libraries</a></p>

<h2 id="using-processing-scripts-ml-files">Using processing scripts (.ml files)</h2>

<p>Since processors can be run individually using system calls, processing pipelines may be formed in many different ways, including bash scripts. However, the preferred way is to use the JavaScript system built in to MountainLab. This allows scripts to be portable and more secure. MountainLab processing scripts can either be run from the command-line or from within a web browser, and can execute jobs on the local machine or on a remote server. Detailed documentation can be found in <a href="docs/processing_scripts.md">processing scripts</a>.</p>

  </div>
</div>


      </div>
      <hr>
      <footer>
        <p><small>
          <a href="http://www.apache.org/licenses/LICENSE-2.0"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/db/Apache_Software_Foundation_Logo_%282016%29.svg/512px-Apache_Software_Foundation_Logo_%282016%29.svg.png" width="10%" alt="Apache"/></a> &nbsp;
          <a href="https://www.simonsfoundation.org/flatiron/">Flatiron Institute</a>
        </small></p>
      </footer>

    </div>
  </body>
</html>

