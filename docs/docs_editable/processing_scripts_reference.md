# MountainLab processing scripts reference

MountainLab processor scripts are used to assemble and execute pipelines of individual processor jobs. They can be run either from the command line or via web browser, and can queue jobs either to the local machine or to a remote server.

## Processor script syntax

Processor script files should have a .ml extension and should be written in pure ECMAScript (JavaScript). They should not *use* any capabilities specific to web browsers or to NodeJS. For example, do not try to *require* a NodeJS modules, or access the *window* object of the browser. Just use pure JavaScript, plus the few added functions described below.

## The *spec* and *main* functions

To allow running and probing of the processing script via ```ml-run-script``` and ```mls-spec```,  use the following two lines at the top of the script:

```
exports.spec = spec;
exports.main = main;
```

Then you must create those two functions in the body of the script. The ```spec``` function should return a JSON object containing the input/output/parameter specification (spec) in the same style as for registered MountainLab processors. The object should have the following fields:

* ```description``` A brief description string for the processing script.
* ```inputs``` A list of inputs (corresponding to input files), each with the following fields
	- ```name``` The name of the input
	- ```optional``` (Boolean) Whether or not this input is optional
* ```outputs``` A list of outputs (corresponding to output files), each with the following fields
	- ```name``` The name of the output
	- ```optional``` (Boolean) Whether or not this output is optional
* ```parameters``` A list of parameters, each with the following fields
	- ```name``` The name of the parameter
	- ```optional``` (Boolean) Whether or not this output is optional
	- ```default_value``` If the parameter is optional, a string representing the default value for the parameter.

An example ```spec``` function is [provided here](processing_scripts.md). The contents of the spec can be obtained from the command line via

```
mls-spec [script_name.ml]
mls-spec [script_name.ml] -p
```

The -p option specifies that the output formatted for humans. Otherwise, a JSON string is output.

The ```main``` function is executed when the script is run via the ```ml-run-script``` command. It should assemble a pipeline of processor jobs by calling ```_MLS.runProcess``` for each job (see below). An example ```main``` function is [provided here](processing_scripts.md).

## Queing processor jobs

The primary task of a processing script is to assemble a pipeline of processor jobs. This is done using the following call

```
_MLS.runProcess(processor_name, inputs, outputs_to_return, parameters, opts)
```

* ```processor_name``` is the name of the registered processor to queue
* ```inputs``` is a JSON object. The keys are names of inputs (corresponding to the processor spec) and the values are objects that represent the input files. These objects can be placeholders obtained as outputs to previously queued processor jobs, or they can be pointers obtained by other means, such as corresponding to a .prv file. These values should never be absolute paths to files on a particular system.
* ```outputs_to_return``` is a JSON object. The keys are names of outputs (corresponding to the processor spec) and the values are Boolean (true or false) specifying whether or not we are requesting that particular output. A placeholder object will be attached to the output object for each requested output (see below).
* ```parameters``` is a JSON object. The keys are names of parameters (corresponding to the processor spec) and the values are strings. These parameters are ultimately passed as parameter arguments in the processor call.

The output of ```_MLS.runProcess``` is a JSON object containing placeholders for the output files. For instance, in the following example, the output object has two fields, one for each of the requested outputs. These could then be used as inputs to a subsequent call to ```_MLS.runProcess```.

```
var A=_MLS.runProcess('pyms.synthesize_random_waveforms',
	{},
	{
		waveforms_out:true,
		geometry_out:true
	},
	{
		M:16,
		K:25
	},
	{}
);
var waveforms = A.waveforms_out;
var geometry = A.geometry_out;
```

## Setting results and outputs

Data files generated by a processing script are only accessible by the user if they are set as results using

```
_MLS.setResult(name, value)
```

* ```name``` A string representing the name of the result, or one of the outputs in the ```outputs``` argument passed in to the call to the ```main``` function
* ```value``` Either a JSON object or a placeholder representing a file output from one of the processor jobs.

If the script was run in a web browser (within MLStudy) then the results will appear in the *Results* window. If the ```value``` represents an output file, then the user can download the corresponding .prv file or, if the file is available on kbucket, they can download the actual file. If the ```value``` is a JSON object, then the user can view or download the JSON content.

If the script was run from the command line and the ```--results=[output_dir]``` option was specified in the command-line call to ```ml-run-script```, then each result will get stored as a .prv file in the ```[output_dir]```. The name of each file will be ```[name].prv``` where ```[name]``` is the name string specified in the call to ```_MLS.setResult```. If the ```name``` argument is the placeholder corresponding to one of the outputs provided in to the call to ```main```, and if that output was also included as an argument in the command-line call to ```ml-run-script```, then the file will get written to that specified location. If that location has a '.prv' ending, then only the PRV object will get written. (It's easier to just look at examples.)


